<!DOCTYPE html>
<html lang="id">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Form Data Keluarga M.Koesbanoe</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        
        /* Hover states and transitions */
        .transition-all {
            transition: all 0.3s ease;
        }
        
        /* Loading spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-center space-x-3">
            <i class="fas fa-users text-2xl text-indigo-600"></i>
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Form Data Keluarga M.Koesbanoe</h1>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 mb-16">
        <!-- Wizard Progress Indicator -->
        <div class="mb-6 flex justify-between items-center">
            <div id="stepIndicator" class="flex space-x-2">
                <div class="step-dot w-3 h-3 rounded-full bg-gray-300"></div>
                <div class="step-dot w-3 h-3 rounded-full bg-gray-300"></div>
                <div class="step-dot w-3 h-3 rounded-full bg-gray-300"></div>
                <div class="step-dot w-3 h-3 rounded-full bg-gray-300"></div>
            </div>
            <div id="stepTitle" class="text-lg font-semibold text-gray-700">Pilih Generasi</div>
        </div>

        <form id="familyForm" class="bg-white rounded-lg shadow-lg p-6 sm:p-8 space-y-6">
            <!-- Step 1: Generasi -->
            <div id="step1" class="step active">
                <div>
                    <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                        <i class="fas fa-layer-group mr-2 text-indigo-600"></i>
                        Pilih Generasi
                    </label>
                    <select 
                        id="generasiSelect" 
                        class="w-full border border-gray-300 rounded-lg p-3 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        required
                    >
                        <option value="">Pilih Generasi</option>
                    </select>
                </div>
                <div class="flex justify-end mt-4">
                    <button 
                        type="button" 
                        onclick="nextStep(1)"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                    >
                        Lanjut <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Orang Tua -->
            <div id="step2" class="step">
                <div>
                    <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                        <i class="fas fa-people-roof mr-2 text-indigo-600"></i>
                        Pilih Orang Tua
                    </label>
                    <select 
                        id="orangTuaSelect" 
                        class="w-full border border-gray-300 rounded-lg p-3 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        required
                    >
                        <option value="">Pilih Orang Tua</option>
                    </select>
                </div>
                <div class="flex justify-between mt-4">
                    <button 
                        type="button" 
                        onclick="prevStep(2)"
                        class="px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    >
                        <i class="fas fa-arrow-left mr-2"></i> Kembali
                    </button>
                    <button 
                        type="button" 
                        onclick="nextStep(2)"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                    >
                        Lanjut <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Data Pribadi -->
            <div id="step3" class="step">
                <div class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                            <i class="fas fa-user mr-2 text-indigo-600"></i>
                            Nama Lengkap
                        </label>
                        <input 
                            type="text" 
                            name="nama" 
                            class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                            required
                            placeholder="Masukkan nama lengkap"
                        >
                    </div>

                    <div>
                        <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                            <i class="fas fa-heart mr-2 text-indigo-600"></i>
                            Status
                        </label>
                        <select 
                            name="status" 
                            class="w-full border border-gray-300 rounded-lg p-3 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        >
                            <option value="hidup">Hidup</option>
                            <option value="almarhum">Almarhum/ah</option>
                        </select>
                    </div>

                    <div>
                        <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                            <i class="fas fa-ring mr-2 text-indigo-600"></i>
                            Nama Pasangan
                        </label>
                        <div class="flex items-center space-x-2">
                            <input 
                                type="text" 
                                name="pasangan" 
                                class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Nama Pasangan (jika ada)"
                            >
                            <label class="inline-flex items-center space-x-2 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="statusPasangan" 
                                    value="almarhum"
                                    class="form-checkbox h-5 w-5 text-indigo-600"
                                >
                                <span class="text-sm text-gray-700">Alm</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                            <i class="fas fa-mobile-alt mr-2 text-indigo-600"></i>
                            Nomor HP/WA
                        </label>
                        <input 
                            type="tel" 
                            name="hp" 
                            class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                            placeholder="Masukkan nomor HP/WA"
                        >
                    </div>

                    <div>
                        <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-indigo-600"></i>
                            Alamat
                        </label>
                        <textarea 
                            name="alamat" 
                            class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                            rows="2"
                            placeholder="Masukkan alamat lengkap"
                        ></textarea>
                    </div>

                    <div class="flex justify-between mt-4">
                        <button 
                            type="button" 
                            onclick="prevStep(3)"
                            class="px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                        >
                            <i class="fas fa-arrow-left mr-2"></i> Kembali
                        </button>
                        <button 
                            type="button" 
                            onclick="nextStep(3)"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                        >
                            Lanjut <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Anak -->
            <div id="step4" class="step">
                <div id="anakContainer">
                    <label class="block font-semibold mb-2 text-gray-700 flex items-center">
                        <i class="fas fa-children mr-2 text-indigo-600"></i>
                        Anak-anak
                    </label>
                    <div id="anakList" class="space-y-2"></div>
                    <button 
                        type="button" 
                        onclick="tambahAnak()"
                        class="mt-2 px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors flex items-center"
                    >
                        <i class="fas fa-plus mr-2"></i>
                        Tambah Anak
                    </button>
                </div>
                
                <div class="flex justify-between mt-4">
                    <button 
                        type="button" 
                        onclick="prevStep(4)"
                        class="px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    >
                        <i class="fas fa-arrow-left mr-2"></i> Kembali
                    </button>
                    <button 
                        type="submit"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                    >
                        <i class="fas fa-save mr-2"></i> Simpan Data
                    </button>
                </div>
            </div>
        </form>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg flex flex-col items-center space-y-4 max-w-sm w-full">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 text-center">Sedang menyimpan data...</p>
        </div>
    </div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="fixed bottom-0 right-0 bg-white p-4 border shadow-lg rounded-tl-lg text-xs max-w-xs overflow-auto max-h-40 hidden">
        <div class="flex justify-between mb-2">
            <strong>Debug Info</strong>
            <button onclick="document.getElementById('debugPanel').classList.add('hidden')" class="text-red-500">&times;</button>
        </div>
        <pre id="debugOutput">Debug info akan muncul di sini</pre>
    </div>

    <!-- SweetAlert2 untuk notifikasi -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Global state untuk form wizard
        let currentStep = 1;
        const totalSteps = 4;
        let isDebugMode = false; // Set ke true untuk debug

        // Fungsi debug
        function debug(message, data) {
            if (!isDebugMode) return;
            
            const output = document.getElementById('debugOutput');
            let text = message;
            
            if (data) {
                if (typeof data === 'object') {
                    text += ': ' + JSON.stringify(data, null, 2);
                } else {
                    text += ': ' + data;
                }
            }
            
            output.textContent = text;
            document.getElementById('debugPanel').classList.remove('hidden');
            console.log(message, data);
        }
        
        // Fungsi untuk toggle debug mode dengan Ctrl+Shift+D
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                isDebugMode = !isDebugMode;
                document.getElementById('debugPanel').classList.toggle('hidden', !isDebugMode);
                debug('Debug mode ' + (isDebugMode ? 'enabled' : 'disabled'));
            }
        });

        // Fungsi untuk menambah anak
        function tambahAnak() {
            const container = document.getElementById('anakList');
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <input 
                    type="text" 
                    name="anak[]" 
                    class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                    placeholder="Nama Anak"
                >
                <button 
                    type="button" 
                    onclick="this.parentElement.remove()" 
                    class="p-2 text-red-600 hover:bg-red-50 rounded-lg h-[44px] w-[44px] flex items-center justify-center"
                >
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        // Fungsi untuk pindah antar step
        function nextStep(step) {
            // Validasi step sebelum pindah
            if (step === 1) {
                const generasi = document.getElementById('generasiSelect').value;
                if (!generasi) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Pilih Generasi',
                        text: 'Silakan pilih generasi terlebih dahulu'
                    });
                    return;
                }
                
                // Tampilkan loading saat mengambil data orangtua
                showLoading();
                document.querySelector('#loadingIndicator p').textContent = "Memuat data orang tua...";
                
                google.script.run
                    .withSuccessHandler(function(parents) {
                        hideLoading();
                        
                        const select = document.getElementById('orangTuaSelect');
                        // Bersihkan pilihan sebelumnya
                        select.innerHTML = '<option value="">Pilih Orang Tua</option>';
                        
                        if (parents && parents.length > 0) {
                            parents.forEach(parent => {
                                const option = document.createElement('option');
                                option.value = parent.nama;
                                option.textContent = `${parent.nama} ${parent.hp ? `(${parent.hp})` : ''}`;
                                select.appendChild(option);
                            });
                            
                            // Sembunyikan step saat ini
                            document.getElementById(`step${step}`).classList.remove('active');
                            
                            // Perbarui indikator step
                            updateStepIndicator(step + 1);
                            
                            // Tampilkan step berikutnya
                            document.getElementById(`step${step + 1}`).classList.add('active');
                            currentStep = step + 1;
                            
                            debug('Loaded parents list', parents);
                        } else {
                            debug('No parents data found', { generasi });
                            Swal.fire({
                                icon: 'info',
                                title: 'Tidak Ada Data Orang Tua',
                                text: `Tidak ditemukan data orang tua untuk generasi "${generasi}". Silakan cek apakah sheet "${generasi} Orang Tua" ada di spreadsheet.`
                            });
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        debug('Error loading parents list', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Gagal memuat daftar orang tua: ' + error
                        });
                    })
                    .getParentsList(generasi);
                
                return; // Hentikan proses, langkah selanjutnya akan ditangani callback
            }

            if (step === 2) {
                const orangTua = document.getElementById('orangTuaSelect').value;
                if (!orangTua) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Pilih Orang Tua',
                        text: 'Silakan pilih orang tua terlebih dahulu'
                    });
                    return;
                }
            }
            
            if (step === 3) {
                const nama = document.querySelector('input[name="nama"]').value;
                if (!nama) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Nama Wajib Diisi',
                        text: 'Silakan isi nama lengkap terlebih dahulu'
                    });
                    return;
                }
            }

            // Sembunyikan step saat ini
            document.getElementById(`step${step}`).classList.remove('active');
            
            // Perbarui indikator step
            updateStepIndicator(step + 1);
            
            // Tampilkan step berikutnya
            document.getElementById(`step${step + 1}`).classList.add('active');
            currentStep = step + 1;
        }

        // Fungsi untuk kembali ke step sebelumnya
        function prevStep(step) {
            // Sembunyikan step saat ini
            document.getElementById(`step${step}`).classList.remove('active');
            
            // Perbarui indikator step
            updateStepIndicator(step - 1);
            
            // Tampilkan step sebelumnya
            document.getElementById(`step${step - 1}`).classList.add('active');
            currentStep = step - 1;
        }

        // Fungsi untuk update indikator step
        function updateStepIndicator(activeStep) {
            const dots = document.querySelectorAll('.step-dot');
            const stepTitle = document.getElementById('stepTitle');
            
            dots.forEach((dot, index) => {
                if (index < activeStep) {
                    dot.classList.remove('bg-gray-300');
                    dot.classList.add('bg-indigo-600');
                } else {
                    dot.classList.remove('bg-indigo-600');
                    dot.classList.add('bg-gray-300');
                }
            });

            // Update judul step
            const titles = [
                'Pilih Generasi', 
                'Pilih Orang Tua', 
                'Data Pribadi', 
                'Data Anak'
            ];
            stepTitle.textContent = titles[activeStep - 1];
        }

        // Fungsi untuk memuat daftar generasi
        function loadGenerasiList() {
            showLoading();
            document.querySelector('#loadingIndicator p').textContent = "Memuat daftar generasi...";
            
            google.script.run
                .withSuccessHandler(function(generasi) {
                    hideLoading();
                    const select = document.getElementById('generasiSelect');
                    
                    if (generasi && generasi.length > 0) {
                        generasi.forEach(gen => {
                            const option = document.createElement('option');
                            option.value = gen;
                            option.textContent = gen;
                            select.appendChild(option);
                        });
                        debug('Loaded generasi list', generasi);
                    } else {
                        debug('No generasi data found', null);
                        Swal.fire({
                            icon: 'warning',
                            title: 'Data Tidak Ditemukan',
                            text: 'Daftar generasi tidak tersedia. Pastikan sheet "Generasi" tersedia dan berisi data.',
                            confirmButtonText: 'Cek Spreadsheet Access',
                            showCancelButton: true,
                            cancelButtonText: 'Tutup'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                checkSpreadsheetAccess();
                            }
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    debug('Error loading generasi list', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Gagal memuat daftar generasi: ' + error,
                        confirmButtonText: 'Cek Spreadsheet Access',
                        showCancelButton: true,
                        cancelButtonText: 'Tutup'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            checkSpreadsheetAccess();
                        }
                    });
                })
                .getGenerasiList();
        }

        // Fungsi untuk menangani submit form
        function handleSubmit(form) {
            showLoading();
            document.querySelector('#loadingIndicator p').textContent = "Sedang menyimpan data...";
            
            const formData = new FormData(form);
            const data = {};
            const anak = [];

            formData.forEach((value, key) => {
                if (key === 'anak[]') {
                    if (value) anak.push(value);
                } else {
                    data[key] = value;
                }
            });

            // Ambil data generasi dan orang tua dari step sebelumnya
            data.generasi = document.getElementById('generasiSelect').value;
            data.orangTua = document.getElementById('orangTuaSelect').value;
            data.anak = anak;
            
            // Log data untuk debug
            debug('Form data yang akan dikirim', data);

            // Validasi data
            if (!data.nama) {
                hideLoading();
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Tidak Lengkap',
                    text: 'Nama harus diisi'
                });
                return false;
            }

            // Disable form selama submit
            const inputs = form.querySelectorAll('input, select, textarea, button');
            inputs.forEach(input => input.disabled = true);

            google.script.run
                .withSuccessHandler(function(result) {
                    debug('Server response', result);
                    hideLoading();
                    inputs.forEach(input => input.disabled = false);
                    
                    if (result && result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            text: 'Data keluarga berhasil disimpan.',
                            confirmButtonColor: '#10B981'
                        }).then(() => {
                            // Reset form setelah sukses
                            form.reset();
                            document.getElementById('anakList').innerHTML = '';
                            
                            // Kembali ke step pertama
                            document.getElementById(`step${currentStep}`).classList.remove('active');
                            document.getElementById('step1').classList.add('active');
                            updateStepIndicator(1);
                            currentStep = 1;
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal!',
                            text: 'Gagal menyimpan data: ' + (result && result.error ? result.error : 'Kesalahan tidak diketahui'),
                            confirmButtonColor: '#EF4444',
                            confirmButtonText: 'Cek Spreadsheet Access',
                            showCancelButton: true,
                            cancelButtonText: 'Tutup'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                checkSpreadsheetAccess();
                            }
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    debug('Server error', error);
                    inputs.forEach(input => input.disabled = false);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Terjadi kesalahan: ' + (error.message || error),
                        confirmButtonColor: '#EF4444',
                        confirmButtonText: 'Cek Spreadsheet Access',
                        showCancelButton: true,
                        cancelButtonText: 'Tutup'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            checkSpreadsheetAccess();
                        }
                    });
                })
                .processForm(data);

            return false; // Mencegah form submit default
        }

        // Fungsi untuk memeriksa akses spreadsheet untuk debug
        function checkSpreadsheetAccess() {
            showLoading();
            document.querySelector('#loadingIndicator p').textContent = "Memeriksa akses spreadsheet...";
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Spreadsheet Ditemukan',
                            html: `
                                <p>Nama: <strong>${result.spreadsheetName}</strong></p>
                                <p>Sheets: <strong>${result.sheets.join(', ')}</strong></p>
                                <p>URL: <a href="${result.url}" target="_blank">${result.url}</a></p>
                            `,
                            confirmButtonColor: '#4F46E5'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal Mengakses Spreadsheet',
                            text: result.error || 'Kesalahan tidak diketahui',
                            confirmButtonColor: '#EF4444'
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error Akses Spreadsheet',
                        text: error.message || error,
                        confirmButtonColor: '#EF4444'
                    });
                })
                .checkSpreadsheetAccess();
        }

        // Fungsi untuk menampilkan loading
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        // Fungsi untuk menyembunyikan loading
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // Panggil fungsi saat halaman dimuat
        window.onload = function() {
            // Tambahkan event listener untuk form
            document.getElementById('familyForm').onsubmit = function(e) {
                e.preventDefault(); // Mencegah submit default
                return handleSubmit(this);
            };
            
            // Tambahkan tombol debug untuk cek spreadsheet access
            if (window.location.search.includes('debug=true')) {
                isDebugMode = true;
                document.getElementById('debugPanel').classList.remove('hidden');
                
                const debugBtn = document.createElement('button');
                debugBtn.className = 'fixed top-4 right-4 bg-gray-800 text-white p-2 rounded-lg text-xs';
                debugBtn.textContent = 'Cek Spreadsheet';
                debugBtn.onclick = checkSpreadsheetAccess;
                document.body.appendChild(debugBtn);
                
                debug('Debug mode active', {
                    url: window.location.href,
                    time: new Date().toISOString()
                });
            }
            
            // Muat daftar generasi
            loadGenerasiList();
        };
    </script>
</body>
</html>
